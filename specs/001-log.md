# Spec 001: Log

## Overview

`git loom` (or `git loom log`) displays a branch-aware commit graph in a
GitButler CLI-inspired style. It shows the commits between the current branch's
upstream tracking branch and HEAD, grouped by feature branch.

## Prerequisites

- The user must be on a local branch (not detached HEAD).
- The branch must have an upstream tracking branch configured (e.g. `origin/main`).

## Output Format

The log is rendered top-to-bottom using UTF-8 box-drawing characters:

Independent branches (each forked from integration line):

```
╭─ [unstaged changes]
│   M file.txt
│   A new_file.rs
│
│╭─ [feature-b]
│●   d0472f9 Fix bug in feature B
│●   7a067a9 Start feature B
├╯
│
│╭─ [feature-a]
│●   2ee61e1 Add feature A
├╯
│
● ff1b247 (upstream) origin/main
```

Stacked branches (feature-b on top of feature-a):

```
│╭─ [feature-b]
│●   4e046ab B2: second commit on feature-b
│●   0b85ca7 B1: first commit on feature-b
││
│├─ [feature-a]
│●   caa87a9 A2: second commit on feature-a
│●   18faee8 A1: first commit on feature-a
├╯
│
● 2bda89d (upstream) origin/main
```

Loose commits (on the integration line, no feature branch):

```
╭─ [unstaged changes]
│   no changes
│
●   abc1234 Fix typo
●   def5678 Refactor utils
│
● ff1b247 (upstream) origin/main
```

### Sections (top to bottom)

1. **Unstaged changes** (optional): shown only if the working tree has
   modifications, new files, or deletions. Introduced with `╭─ [unstaged changes]`.
   Each file is listed with its status character (`M`, `A`, `D`, `R`, `?`).

2. **Feature branches**: each local branch whose tip is reachable from HEAD but
   not from the upstream tip is rendered as a side branch. The branch name
   appears on its own line in brackets (`│╭─ [branch-name]`), followed by
   its commits (`│●`), and closed with `├╯`.

3. **Loose commits**: commits not belonging to any detected feature branch are
   shown on the main integration line (`●`).

4. **Upstream marker**: the bottom line shows the upstream commit on the main
   line (`● <hash> (upstream) <remote>/<branch>`).

### Symbols

| Symbol | Meaning |
|--------|---------|
| `╭─`   | Start of a section (unstaged changes or first branch in a stack) |
| `├─`   | Start of a subsequent branch within a stack |
| `│`    | Continuation of the integration line (dotted) |
| `││`   | Continuation between stacked branches |
| `●`    | A commit |
| `├╯`   | End of a side branch (or stack), merging back to integration line |
| `M/A/D/R/?` | File status: modified, added, deleted, renamed, unknown |

### Commit line format

Each commit is displayed as: `<short-hash> <first line of commit message>`

Short hashes are generated by libgit2's `short_id()`, which respects the
repository's `core.abbrev` setting and ensures uniqueness.

## Branch Detection

Feature branches are detected automatically: all local branches whose tip
commit is in the range `upstream..HEAD` (exclusive of the upstream commit,
inclusive of HEAD) are considered feature branches. The current branch (the
integration branch) is excluded from side branches.

## CLI

| Command | Behavior |
|---------|----------|
| `git-loom` | Shows the log (default command) |
| `git-loom log` | Shows the log (explicit) |

## Design Decisions

- **No colors**: the output is plain text with no ANSI color codes. Color
  support will be added in a future iteration.
- **No merge commit handling**: merge commits are displayed like regular
  commits. There is no special visual treatment for merges.

## Branch Topology

Feature branches are expected to be stacked linearly on top of each other.
Given feature-a (A1→A2) and feature-b (B1→B2), the commit history is:

```
B2 → B1 → A2 → A1 → upstream
          ^          ^
          feature-a  upstream tip
^
feature-b
```

The topological walk naturally groups commits by branch in this model.
Parallel branches forking from the same point are not a supported topology.
