# Spec 001: Status

## Overview

`git loom` (or `git loom status`) displays a branch-aware commit graph in a
GitButler CLI-inspired style. It shows the commits between the current branch's
upstream tracking branch and HEAD, grouped by feature branch.

## Prerequisites

- The user must be on a local branch (not detached HEAD).
- The branch must have an upstream tracking branch configured (e.g. `origin/main`).

## Output Format

The log is rendered top-to-bottom using UTF-8 box-drawing characters:

Independent branches (each forked from integration line):

```
╭─ [unstaged changes]
│   M file.txt
│   A new_file.rs
│
│╭─ [feature-b]
│●   d0472f9 Fix bug in feature B
│●   7a067a9 Start feature B
├╯
│
│╭─ [feature-a]
│●   2ee61e1 Add feature A
├╯
│
● ff1b247 (upstream) [origin/main] Initial commit
```

Stacked branches (feature-b on top of feature-a):

```
│╭─ [feature-b]
│●   4e046ab B2: second commit on feature-b
│●   0b85ca7 B1: first commit on feature-b
││
│├─ [feature-a]
│●   caa87a9 A2: second commit on feature-a
│●   18faee8 A1: first commit on feature-a
├╯
│
● 2bda89d (upstream) [origin/main] Initial commit
```

Co-located branches (multiple branches pointing to the same commit):

```
│╭─ [feature-a-v2]
│├─ [feature-a]
│●   2ee61e1 Add feature A
├╯
│
● ff1b247 (upstream) [origin/main] Initial commit
```

When several branches share the same tip commit, they are displayed as
multiple header lines above the same set of commits. The newest branch
(alphabetically last) appears on top with `│╭─`, and additional branches
use `│├─`.

Branches at the upstream base (no commits in range):

```
│╭─ [feature-a]
│●   2ee61e1 Add feature A
├╯
│
│╭─ [feature-stale]
├╯
│
● ff1b247 (upstream) [origin/main] Initial commit
```

Local branches whose tip is the merge-base commit are shown as empty
branch sections (header and close, no commits) above the upstream marker.
Branches that track the same upstream remote as the integration branch
(e.g. `main` tracking `origin/main`) are excluded.

Loose commits (on the integration line, no feature branch):

```
╭─ [unstaged changes]
│   no changes
│
●   abc1234 Fix typo
●   def5678 Refactor utils
│
● ff1b247 (upstream) [origin/main] Initial commit
```

Upstream ahead (upstream has new commits beyond the common base):

```
●   abc1234 Fix typo
│
│●  [origin/main] ⏫ 3 new commits
├╯ 204e309 (common base) 2025-07-06 Merge pull request #10
```

### Sections (top to bottom)

1. **Unstaged changes** (optional): shown only if the working tree has
   modifications, new files, or deletions. Introduced with `╭─ [unstaged changes]`.
   Each file is listed with its status character (`M`, `A`, `D`, `R`, `?`).

2. **Feature branches**: each local branch whose tip is reachable from HEAD
   (or at the merge-base) is rendered as a side branch. The branch name
   appears on its own line in brackets (`│╭─ [branch-name]`), followed by
   its commits (`│●`), and closed with `├╯`. When multiple branches share
   the same tip commit (co-located), they are shown as multiple header lines
   above the same commits, with the newest on top. Branches at the
   merge-base with no commits in range are shown as empty sections (header
   and close only).

3. **Loose commits**: commits not belonging to any detected feature branch are
   shown on the main integration line (`●`).

4. **Upstream / common base marker**: the bottom of the log shows the merge-base
   (common ancestor) between HEAD and the upstream tracking branch. When upstream
   is up-to-date: `● <hash> (upstream) [<remote>/<branch>] <message>`.
   When upstream has moved ahead, a side-branch indicator is shown:
   `│●  [<remote>/<branch>] ⏫ N new commits` followed by
   `├╯ <hash> (common base) <date> <message>`.

### Symbols

| Symbol | Meaning |
|--------|---------|
| `╭─`   | Start of a section (unstaged changes or first branch in a stack/group) |
| `├─`   | Start of a subsequent branch within a stack or co-located group |
| `│`    | Continuation of the integration line (dotted) |
| `││`   | Continuation between stacked branches |
| `●`    | A commit |
| `├╯`   | End of a side branch (or stack), merging back to integration line |
| `M/A/D/R/?` | File status: modified, added, deleted, renamed, unknown |
| `⏫`  | Upstream has new commits ahead of the common base |

### Commit line format

Each commit is displayed as: `<short-hash> <first line of commit message>`

Short hashes are generated by libgit2's `short_id()`, which respects the
repository's `core.abbrev` setting and ensures uniqueness.

## Branch Detection

Feature branches are detected automatically: all local branches whose tip
commit is in the range `upstream..HEAD` (inclusive of HEAD) or at the
merge-base commit are considered feature branches. The current branch (the
integration branch) is excluded from side branches. Branches that track
the same upstream remote as the integration branch (e.g. `main` tracking
`origin/main`) are also excluded.

## CLI

| Command | Behavior |
|---------|----------|
| `git-loom` | Shows the status (default command) |
| `git-loom status` | Shows the status (explicit) |

## Design Decisions

- **Colored output**: ANSI colors are used via the `colored` crate. Colors
  are defined as constants at the top of `graph.rs` for easy customization.
  Colors can be disabled with `--no-color` or the `NO_COLOR` environment variable.
- **No merge commit handling**: merge commits are displayed like regular
  commits. There is no special visual treatment for merges.

## Branch Topology

Feature branches are expected to be stacked linearly on top of each other.
Given feature-a (A1→A2) and feature-b (B1→B2), the commit history is:

```
B2 → B1 → A2 → A1 → upstream
          ^          ^
          feature-a  upstream tip
^
feature-b
```

The topological walk naturally groups commits by branch in this model.
Parallel branches forking from the same point are not a supported topology.
